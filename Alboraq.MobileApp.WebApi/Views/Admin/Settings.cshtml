@model Alboraq.MobileApp.WebApi.Models.MVC.Admin.AdminSettingsViewModel

@{
    ViewBag.Title = "Settings";
}

@Html.Partial("_Modal")

<h2>Settings</h2>

<ul class="nav nav-tabs nav-justified" role="tablist">
    <li role="presentation" class="active"><a href="#users" role="tab" data-toggle="tab">Users</a></li>
    <li role="presentation"><a href="#roles" data-toggle="tab">Role</a></li>
</ul>

<div class="tab-content">
    <div id="users" role="tabpanel" class="tab-pane fade in active">
        @Html.Partial("_UsersPartialView", Model)
    </div>
    <div id="roles" role="tabpanel" class="tab-pane fade">
        @Html.Partial("_RolesPartialView", Model.Roles)
    </div>
</div>

@section scripts{
    <script>
        (function ($, widgetObject) {
            var controls = {
                appModal: $('#appModal'),
                appModalContent: $('#appModal .modal-content'),
                btnAddUserDialog: $('#btnAddUserDialog'),
                btnEditUserDialog: $('#btnEditUserDialog'),
                btnChangePasswordDialog: $('#btnChangePasswordDialog'),
                btnResetPasswordDialog: $('#btnResetPasswordDialog')
            };

            widgetObject.init = function () {
                bindUiActions();
            };

            var bindUiActions = function () {

                controls.btnAddUserDialog.on('click', function () {

                    controls.appModal.find('.modal-title').text('Add new user');
                    controls.appModal.find('.modal-dialog').addClass('modal-sm');
                    controls.appModal.find('.modal-footer')
                        .append('<button id="btnCloseDialog" type="button" class="btn btn-default">Close</button>'); 

                    var appModalBody = controls.appModal.find('.modal-body');

                    appModalBody.append('<p class="text-center"><i class="fa fa-spinner fa-pulse fa-2x"></i></p>');

                    appModalBody.load('/admin/NewUserPartialView', function () {
                        //add the form in the controls object
                        controls.frmNewUser = controls.appModalContent.find('#frmNewUser');

                        //bind the validation
                        controls.frmNewUser.validate({
                            rules: {
                                Name: 'required',
                                Email: {
                                    required: true,
                                    email: true //validated by the built-in email rule
                                },
                                Password: {
                                    required: true,
                                    minlength: 6
                                },
                                ConfirmPassword: {
                                    equalTo: '#Password'
                                },
                                PhoneNumber: 'required'
                            },
                            messages: {
                                Name: 'Please enter your name',
                                Email: 'Please enter a valid email address',
                                Password: {
                                    required: 'Please provide a password',
                                    minlength: 'The password atleast 6 characters long'
                                },
                                PhoneNumber: 'Please enter a mobile number'
                            },
                            submitHandler: function (form) {                                
                                controls.frmNewUser.trigger('submit');
                            }
                        });
                    });   
                    
                });

                controls.appModal.on('shown.bs.modal', function () {                    
                    if ($('#Name')) {
                        $('#Name').focus();
                    }
                });

                controls.appModal.on('hidden.bs.modal', function () {
                    //remove existing button in modal-footer 
                    //that has been created dynamically
                    $(this).find('.modal-footer').empty();
                });

                controls.appModalContent.on('click', '#btnCloseDialog', function () {
                    controls.appModal.modal('hide');
                });

                controls.appModalContent.on('submit', '#frmNewUser', function (e) {
                    e.preventDefault();

                    var form = $(this);                    

                    //animate button submit
                    controls.appModal.find('#btnAddSubmit').html('Creating user..&nbsp; <i class="fa fa-spinner fa-pulse></i>')
                        .addClass('disabled');

                    //disable this to prevent close the modal while creating a user
                    controls.appModal.find('#btnCloseDialog').addClass('disabled');
                    controls.appModal.find('.close').addClass('hidden');

                    var alertDialog = $('<div class="alert"></div>');        

                    $.ajax({
                        method: 'post',
                        url: '/api/account/register',
                        data: form.serialize(),
                        success: function (response) {                                                                          
                            alertDialog.addClass('alert-success').append('<p class="text-center">User ' + response.Email + ' has been created!</p>');

                            controls.appModal.find('.modal-body').prepend(alertDialog);

                            //enable the control state
                            controls.appModal.find('#btnAddSubmit').html('Submit')
                                .removeClass('disabled');
                            controls.appModal.find('#btnCloseDialog').removeClass('disabled');
                            controls.appModal.find('.close').removeClass('hidden');
                        },
                        error: function (jqXHR) {

                            //alertDialog.addClass('text-danger').append('<p class="text-center">User ' + jqXHR.respo + ' has been created!</p>');

                            //controls.appModal.find('.modal-body').prepend(alertDialog);
                            //TO DO: SHOW THE ERROR!                                                       
                            console.log(jqXHR.responseJSON);
                            $.each(jqXHR.responseJSON, function (key, value) {
                                if (typeof value === 'object') {
                                    console.log(value);
                                }
                            });
                            controls.appModal.find('#btnAddSubmit').html('Submit')
                                .removeClass('disabled');
                        }
                    });
                });

                controls.btnEditUserDialog.on('click', function (event) {
                    var btn = $(event.currentTarget),
                        userID = btn.data('userid');                    

                    controls.appModal.find('.modal-title').text('Edit user');
                    controls.appModal.find('.modal-dialog').addClass('modal-sm');
                    controls.appModal.find('.modal-footer')
                        .append('<button id="btnCloseDialog" type="button" class="btn btn-default">Close</button>');

                    var appModalBody = controls.appModal.find('.modal-body');

                    appModalBody.append('<p class="text-center"><i class="fa fa-spinner fa-pulse fa-2x"></i></p>');

                    appModalBody.load('/admin/edituserpartialview?userID=' +userID);

                    controls.appModal.modal('show');
                });

                controls.appModalContent.on('submit', '#frmUpdateUser', function (e) {
                    e.preventDefault();

                    
                });
            };
        })(jQuery, window.UserWidget = window.UserWidget || {});

        UserWidget.init();

        
    </script>
}